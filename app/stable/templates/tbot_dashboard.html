<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="/static/img/favicon.ico" type="image/x-icon">
  <style>
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, .3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .fade-enter {
      opacity: 0;
      transition: opacity 0.3s ease-in;
    }

    .fade-enter-active {
      opacity: 1;
    }

    .table-container {
      position: relative;
      min-height: 100px;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(17, 24, 39, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
  </style>
</head>

<body class="bg-gray-900 text-gray-200">
  <!-- Header -->
  <header class="bg-gray-800 text-gray-100 p-4 flex justify-between items-center sticky top-0 z-50 shadow-lg">
    <h1 class="text-2xl font-bold">Trading Dashboard</h1>
    <div class="flex gap-4">
      <div class="flex items-center">
        <input type="checkbox" id="autoRefresh" class="mr-2" onchange="toggleAutoRefresh(this.checked)">
        <label for="autoRefresh">Auto-refresh (30s)</label>
      </div>
      <button onclick="fetchData()"
        class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition-colors flex items-center gap-2">
        <span>Refresh Data</span>
        <span id="refreshSpinner" class="spinner hidden"></span>
      </button>
    </div>
  </header>

  <!-- Current P&L -->
  <section class="max-w-6xl mx-auto mt-6 p-4 bg-gray-800 rounded-lg shadow">
    <h2 class="text-xl font-semibold mb-4 text-gray-100">Current P&L</h2>
    <div id="pnl-metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="bg-gray-700 p-4 rounded shadow animate-pulse">
        <p class="text-gray-300">Loading...</p>
      </div>
    </div>
  </section>

  <!-- Active Positions -->
  <section class="max-w-6xl mx-auto mt-6 p-4 bg-gray-800 rounded-lg shadow">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-100">Active Positions</h2>
      <button onclick="closeAllPositions()" id="closeAllBtn"
        class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
        Close All Positions
      </button>
    </div>
    <div class="table-container">
      <div id="positionsLoading" class="loading-overlay hidden">
        <div class="spinner"></div>
      </div>
      <div class="overflow-x-auto">
        <table class="table-auto w-full text-left border-collapse border border-gray-700">
          <thead>
            <tr class="bg-gray-700 text-gray-300">
              <th class="border border-gray-600 px-4 py-2">Symbol</th>
              <th class="border border-gray-600 px-4 py-2">Position</th>
              <th class="border border-gray-600 px-4 py-2">Market Price</th>
              <th class="border border-gray-600 px-4 py-2">Market Value</th>
              <th class="border border-gray-600 px-4 py-2">Average Cost</th>
              <th class="border border-gray-600 px-4 py-2">Unrealized P&L</th>
              <th class="border border-gray-600 px-4 py-2">Actions</th>
            </tr>
          </thead>
          <tbody id="positions">
            <tr>
              <td colspan="7" class="text-center p-4">Loading positions...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Alerts -->
  <section class="max-w-6xl mx-auto mt-6 p-4 bg-gray-800 rounded-lg shadow">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-100">Alerts</h2>
      <span id="lastUpdateTime" class="text-gray-400 text-sm"></span>
    </div>
    <div class="table-container">
      <div id="alertsLoading" class="loading-overlay hidden">
        <div class="spinner"></div>
      </div>
      <div class="overflow-x-auto">
        <table class="table-auto w-full text-left border-collapse border border-gray-700">
          <thead>
            <tr class="bg-gray-700 text-gray-300">
              <th class="border border-gray-600 px-4 py-2">Timestamp</th>
              <th class="border border-gray-600 px-4 py-2">Ticker</th>
              <th class="border border-gray-600 px-4 py-2">Status</th>
              <th class="border border-gray-600 px-4 py-2">Direction</th>
              <th class="border border-gray-600 px-4 py-2">Entry Limit</th>
              <th class="border border-gray-600 px-4 py-2">Entry Stop</th>
              <th class="border border-gray-600 px-4 py-2">Exit Limit</th>
              <th class="border border-gray-600 px-4 py-2">Exit Stop</th>
            </tr>
          </thead>
          <tbody id="alerts">
            <tr>
              <td colspan="8" class="text-center p-4">Loading alerts...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Trades -->
  <section class="max-w-6xl mx-auto mt-6 p-4 bg-gray-800 rounded-lg shadow mb-8">
    <h2 class="text-xl font-semibold mb-4 text-gray-100">Recent Trades</h2>
    <div class="table-container">
      <div id="tradesLoading" class="loading-overlay hidden">
        <div class="spinner"></div>
      </div>
      <div class="overflow-x-auto">
        <table class="table-auto w-full text-left border-collapse border border-gray-700">
          <thead>
            <tr class="bg-gray-700 text-gray-300">
              <th class="border border-gray-600 px-4 py-2">Trade Time</th>
              <th class="border border-gray-600 px-4 py-2">Symbol</th>
              <th class="border border-gray-600 px-4 py-2">Action</th>
              <th class="border border-gray-600 px-4 py-2">Quantity</th>
              <th class="border border-gray-600 px-4 py-2">Fill Price</th>
              <th class="border border-gray-600 px-4 py-2">Commission</th>
              <th class="border border-gray-600 px-4 py-2">Realized P&L</th>
            </tr>
          </thead>
          <tbody id="trades">
            <tr>
              <td colspan="7" class="text-center p-4">Loading trades...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <script>
    let refreshInterval;
    const REFRESH_INTERVAL = 30000; // 30 seconds

    // Error handling wrapper
    async function safeRequest(url, options = {}) {
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        console.error(`Error fetching ${url}:`, error);
        throw error;
      }
    }

    function toggleLoading(elementId, show) {
      const loadingElement = document.getElementById(elementId);
      if (loadingElement) {
        loadingElement.classList.toggle('hidden', !show);
      }
    }

    function toggleAutoRefresh(enabled) {
      if (enabled) {
        refreshInterval = setInterval(fetchData, REFRESH_INTERVAL);
      } else {
        clearInterval(refreshInterval);
      }
    }

    async function fetchData() {
      const refreshButton = document.querySelector('button[onclick="fetchData()"]');
      const spinner = document.getElementById('refreshSpinner');

      try {
        refreshButton.disabled = true;
        spinner.classList.remove('hidden');

        toggleLoading('positionsLoading', true);
        toggleLoading('alertsLoading', true);
        toggleLoading('tradesLoading', true);

        const [pnlData, tradesData, positionsData] = await Promise.all([
          safeRequest("/api/current-pnl"),
          safeRequest("/api/trades"),
          safeRequest("/api/positions")
        ]);

        updatePnLMetrics(pnlData.data);
        updateTrades(tradesData.data.trades);
        updatePositions(positionsData.data.active_positions);
        await fetchAlerts();

        document.getElementById('lastUpdateTime').textContent =
          `Last updated: ${new Date().toLocaleTimeString()}`;
      } catch (error) {
        console.error("Error in fetchData:", error);
        showError("Failed to refresh data. Please try again.");
      } finally {
        refreshButton.disabled = false;
        spinner.classList.add('hidden');
        toggleLoading('positionsLoading', false);
        toggleLoading('alertsLoading', false);
        toggleLoading('tradesLoading', false);
      }
    }

    function showError(message) {
      // Create or update error toast
      let toast = document.getElementById('errorToast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'errorToast';
        toast.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-enter';
        document.body.appendChild(toast);
      }
      toast.textContent = message;

      // Remove after 3 seconds
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    async function fetchAlerts() {
      try {
        const currentTime = new Date().getTime();
        const result = await safeRequest(
          `https://tv.porenta.us/alerts/data?_=${currentTime}`
        );
        updateAlerts(result.data);
      } catch (error) {
        console.error("Error fetching alerts:", error);
        const alertsTable = document.getElementById("alerts");
        alertsTable.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-red-500">Failed to load alerts.</td></tr>';
      }
    }

    function updatePnLMetrics(data) {
      const pnlMetrics = document.getElementById("pnl-metrics");
      pnlMetrics.innerHTML = `
                <div class="bg-gray-700 p-4 rounded shadow text-center">
                    <p class="text-gray-300">Daily P&L</p>
                    <p class="text-xl ${data.daily_pnl >= 0 ? "text-green-500" : "text-red-500"}">
                        ${data.daily_pnl.toFixed(2)}
                    </p>
                </div>
                <div class="bg-gray-700 p-4 rounded shadow text-center">
                    <p class="text-gray-300">Total Unrealized P&L</p>
                    <p class="text-xl ${data.total_unrealized_pnl >= 0 ? "text-green-500" : "text-red-500"}">
                        ${data.total_unrealized_pnl.toFixed(2)}
                    </p>
                </div>
                <div class="bg-gray-700 p-4 rounded shadow text-center">
                    <p class="text-gray-300">Total Realized P&L</p>
                    <p class="text-xl ${data.total_realized_pnl >= 0 ? "text-green-500" : "text-red-500"}">
                        ${data.total_realized_pnl.toFixed(2)}
                    </p>
                </div>
                <div class="bg-gray-700 p-4 rounded shadow text-center">
                    <p class="text-gray-300">Net Liquidation</p>
                    <p class="text-xl text-blue-500">${data.net_liquidation.toFixed(2)}</p>
                </div>
            `;
    }

    function updateTrades(trades) {
      const tradesTable = document.getElementById("trades");
      if (!trades || trades.length === 0) {
        tradesTable.innerHTML = '<tr><td colspan="7" class="text-center p-4">No trades found.</td></tr>';
        return;
      }

      tradesTable.innerHTML = trades.map(trade => `
                <tr class="bg-gray-800 hover:bg-gray-700">
                    <td class="border border-gray-700 px-4 py-2">${toDenverTime(trade.trade_time, 'long')}</td>
                    <td class="border border-gray-700 px-4 py-2">${trade.symbol}</td>
                    <td class="border border-gray-700 px-4 py-2">${trade.action}</td>
                    <td class="border border-gray-700 px-4 py-2">${trade.quantity}</td>
                    <td class="border border-gray-700 px-4 py-2">${trade.fill_price.toFixed(2)}</td>
                    <td class="border border-gray-700 px-4 py-2">${trade.commission.toFixed(2)}</td>
                    <td class="border border-gray-700 px-4 py-2 ${trade.realized_pnl >= 0 ? "text-green-500" : "text-red-500"}">
                        ${trade.realized_pnl.toFixed(2)}
                    </td>
                </tr>
            `).join("");
    }

    function updatePositions(positions) {
      const positionsTable = document.getElementById("positions");
      const closeAllBtn = document.getElementById("closeAllBtn");

      if (!positions || positions.length === 0) {
        positionsTable.innerHTML = '<tr><td colspan="7" class="text-center p-4">No active positions.</td></tr>';
        closeAllBtn.disabled = true;
        return;
      }

      closeAllBtn.disabled = false;
      positionsTable.innerHTML = positions.map(position => `
        <tr class="bg-gray-800 hover:bg-gray-700">
            <td class="border border-gray-700 px-4 py-2">${position.symbol}</td>
            <td class="border border-gray-700 px-4 py-2">${position.position}</td>
            <td class="border border-gray-700 px-4 py-2">${position.market_price.toFixed(2)}</td>
            <td class="border border-gray-700 px-4 py-2">${position.market_value.toFixed(2)}</td>
            <td class="border border-gray-700 px-4 py-2">${position.average_cost.toFixed(2)}</td>
            <td class="border border-gray-700 px-4 py-2 ${position.unrealized_pnl >= 0 ? "text-green-500" : "text-red-500"}">
                ${position.unrealized_pnl.toFixed(2)}
            </td>
            <td class="border border-gray-700 px-4 py-2">
                <button 
                    class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded text-white transition-colors"
                    data-position='${JSON.stringify(position)}'
                    onclick="handleClosePositionClick(this)"
                >
                    Close
                </button>
            </td>
        </tr>
    `).join("");
    }

    function handleClosePositionClick(button) {
      const position = JSON.parse(button.dataset.position);
      handleClosePosition(position, button);
    }
    function updateAlerts(alerts) {
      const alertsTable = document.getElementById("alerts");
      if (!alerts || alerts.length === 0) {
        alertsTable.innerHTML = '<tr><td colspan="8" class="text-center p-4">No alerts found.</td></tr>';
        return;
      }

      alertsTable.innerHTML = alerts.map(alert => `
                <tr class="bg-gray-800 hover:bg-gray-700">
                    <td class="border border-gray-700 px-4 py-2">${toDenverTime(alert.timestamp, 'long')}</td>
                    <td class="border border-gray-700 px-4 py-2">${alert.ticker}</td>
                    <td class="border border-gray-700 px-4 py-2">${alert.alertstatus}</td>
                    <td class="border border-gray-700 px-4 py-2">${alert.direction}</td>
                    <td class="border border-gray-700 px-4 py-2">${alert.entrylimit.toFixed(2)}</td>
                    <td class="border border-gray-700 px-4 py-2">${alert.entrystop.toFixed(2)}</td>
                    <td class="border border-gray-700 px-4 py-2">${alert.exitlimit.toFixed(2)}</td>
                    <td class="border border-gray-700 px-4 py-2">${alert.exitstop.toFixed(2)}</td>
                </tr>
            `).join("");
    }

    async function closeAllPositions() {
      const confirmed = await showConfirmDialog(
        'Close All Positions',
        'Are you sure you want to close all positions? This action cannot be undone.'
      );

      if (!confirmed) return;

      const closeAllBtn = document.getElementById('closeAllBtn');
      closeAllBtn.disabled = true;
      closeAllBtn.innerHTML = '<span class="spinner"></span> Closing...';

      try {
        const response = await safeRequest("/api/positions");
        const positions = response.data.active_positions;

        await Promise.all(positions.map(position => {
          return handleClosePosition(position, null, true);
        }));

        showSuccess("All positions closed successfully");
        await fetchData();
      } catch (error) {
        console.error('Error closing all positions:', error);
        showError('Failed to close all positions. Please try again.');
      } finally {
        closeAllBtn.disabled = false;
        closeAllBtn.textContent = 'Close All Positions';
      }
    }

    async function getCurrentNYTime() {
      // Create date object in NY timezone
      const date = new Date();
      const nyTime = new Date(date.toLocaleString('en-US', { timeZone: 'America/New_York' }));
      const hours = nyTime.getHours();
      const minutes = nyTime.getMinutes();

      // Check if we're after market hours (after 16:00 ET)
      return hours >= 16 || (hours === 16 && minutes >= 0);
    }

    async function handleClosePosition(position, button, isBatch = false) {
      if (!isBatch) {
        const confirmed = await showConfirmDialog(
          'Close Position',
          `Are you sure you want to close your position in ${position.symbol}?`
        );
        if (!confirmed) return;
      }

      if (button) {
        button.disabled = true;
        button.innerHTML = '<span class="spinner"></span>';
      }

      try {
        const quantity = Math.abs(position.position);
        const isLongPosition = position.position > 0;
        const isAfterHours = await getCurrentNYTime();

        // Webhook payload changes based on market hours
        const webhookPayload = {
          timestamp: Date.now(),
          ticker: position.symbol,
          currency: "USD",
          timeframe: "S",
          clientId: 1,
          key: "mrsprinkles",
          contract: "stock",
          orderRef: `close-all-${position.symbol}-${Date.now()}`
        };

        if (isAfterHours) {
          // After hours - use position-specific direction
          webhookPayload.direction = isLongPosition ? "strategy.entryshort" : "strategy.entrylong";
          webhookPayload.metrics = [
            { name: "entry.limit", value: position.market_price },
            { name: "entry.stop", value: 0 },
            { name: "exit.limit", value: 0 },
            { name: "exit.stop", value: 0 },
            { name: "qty", value: quantity },
            { name: "price", value: position.market_price }
          ];
        } else {
          // Market hours - use close_all strategy
          webhookPayload.direction = "strategy.close_all";
          webhookPayload.metrics = [
            { name: "entry.limit", value: 0 },
            { name: "entry.stop", value: 0 },
            { name: "exit.limit", value: 0 },
            { name: "exit.stop", value: 0 },
            { name: "qty", value: -10000000000 },
            { name: "price", value: position.market_price }
          ];
        }

        await Promise.all([
          // Webhook call
          safeRequest("/proxy/webhook", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(webhookPayload)
          }),

          // Close position endpoint
          safeRequest("/close_positions", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              positions: [{
                symbol: position.symbol,
                action: isLongPosition ? 'SELL' : 'BUY',
                quantity: quantity,
                price: position.market_price
              }]
            })
          })
        ]);

        if (!isBatch) {
          showSuccess(`Position in ${position.symbol} closed successfully`);
          await fetchData();
        }
      } catch (error) {
        console.error('Error closing position:', error);
        if (!isBatch) {
          showError(`Failed to close position in ${position.symbol}`);
        }
        throw error;
      } finally {
        if (button) {
          button.disabled = false;
          button.textContent = 'Close';
        }
      }
    }

    async function closeAllPositions() {
      const confirmed = await showConfirmDialog(
        'Close All Positions',
        'Are you sure you want to close all positions? This action cannot be undone.'
      );

      if (!confirmed) return;

      const closeAllBtn = document.getElementById('closeAllBtn');
      closeAllBtn.disabled = true;
      closeAllBtn.innerHTML = '<span class="spinner"></span> Closing...';

      try {
        const response = await safeRequest("/api/positions");
        const positions = response.data.active_positions;

        await Promise.all(positions.map(position => {
          return handleClosePosition(position, null, true);
        }));

        showSuccess("All positions closed successfully");
        await fetchData();
      } catch (error) {
        console.error('Error closing all positions:', error);
        showError('Failed to close all positions. Please try again.');
      } finally {
        closeAllBtn.disabled = false;
        closeAllBtn.textContent = 'Close All Positions';
      }
    }
    function showSuccess(message) {
      const toast = createToast(message, 'bg-green-500');
      setTimeout(() => toast.remove(), 3000);
    }

    function createToast(message, colorClass) {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-4 right-4 ${colorClass} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-enter`;
      toast.textContent = message;
      document.body.appendChild(toast);
      return toast;
    }

    function showConfirmDialog(title, message) {
      return new Promise(resolve => {
        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

        dialog.innerHTML = `
            <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold mb-2">${title}</h3>
                <p class="text-gray-300 mb-6">${message}</p>
                <div class="flex justify-end gap-4">
                    <button class="cancel-btn px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded text-white transition-colors">
                        Cancel
                    </button>
                    <button class="confirm-btn px-4 py-2 bg-red-500 hover:bg-red-600 rounded text-white transition-colors">
                        Confirm
                    </button>
                </div>
            </div>
        `;

        // Add event listeners after the dialog is added to DOM
        document.body.appendChild(dialog);

        const cancelBtn = dialog.querySelector('.cancel-btn');
        const confirmBtn = dialog.querySelector('.confirm-btn');

        cancelBtn.addEventListener('click', () => {
          dialog.remove();
          resolve(false);
        });

        confirmBtn.addEventListener('click', () => {
          dialog.remove();
          resolve(true);
        });
      });
    }

    function toDenverTime(timestamp, format = "short") {
      if (!timestamp) return "Invalid Timestamp";

      try {
        const options = {
          timeZone: "America/Denver",
          hour12: true
        };

        if (format === "short") {
          Object.assign(options, {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            fractionalSecondDigits: 3
          });
        } else {
          Object.assign(options, {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            fractionalSecondDigits: 3
          });
        }

        return new Intl.DateTimeFormat("en-US", options).format(new Date(timestamp));
      } catch (error) {
        console.error(`Error formatting timestamp: ${timestamp}`, error);
        return "Invalid Timestamp";
      }
    }

    // Initialize dashboard
    document.addEventListener("DOMContentLoaded", () => {
      fetchData();
    });
  </script>
</body>

</html>